generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["app"]
}

model assessment_attempts {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  assessment_id String?      @db.Uuid
  student_id    String?      @db.Uuid
  score         Decimal?     @db.Decimal
  answers       Json?
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  assessments   assessments? @relation(fields: [assessment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  students      students?    @relation(fields: [student_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

model assessments {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title               String?
  subject_id          String?
  curriculum_id       String?
  metadata            Json?
  created_by          String?               @db.Uuid
  created_at          DateTime?             @default(now()) @db.Timestamptz(6)
  assessment_attempts assessment_attempts[]
  users               users?                @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  curricula           curricula?            @relation(fields: [curriculum_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subjects            subjects?             @relation(fields: [subject_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

model audit_logs {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actor_user_id String?   @db.Uuid
  action        String?
  object_type   String?
  object_id     String?
  details       Json?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  users         users?    @relation(fields: [actor_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model bookings {
  id                String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id        String?    @db.Uuid
  package_id        String?
  subject_id        String?
  curriculum_id     String?
  requested_start   DateTime?  @db.Timestamptz(6)
  requested_end     DateTime?  @db.Timestamptz(6)
  status            String?
  assigned_tutor_id String?    @db.Uuid
  note              String?
  created_at        DateTime?  @default(now()) @db.Timestamptz(6)
  tutors            tutors?    @relation(fields: [assigned_tutor_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  curricula         curricula? @relation(fields: [curriculum_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  packages          packages?  @relation(fields: [package_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  students          students?  @relation(fields: [student_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subjects          subjects?  @relation(fields: [subject_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  program_id        String?    @db.Uuid
  program           Program?   @relation(fields: [program_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sessions          sessions[]

  @@schema("app")
}

model curricula {
  id                     String                   @id
  name                   String
  country                String?
  description            String?
  created_at             DateTime?                @default(now()) @db.Timestamptz(6)
  assessments            assessments[]
  bookings               bookings[]
  curriculum_subject_map curriculum_subject_map[]
  progress_points        progress_points[]
  students               students[]

  @@schema("app")
}

model curriculum_subject_map {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  curriculum_id String?
  subject_id    String?
  external_code String?
  curricula     curricula? @relation(fields: [curriculum_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subjects      subjects?  @relation(fields: [subject_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

model notifications {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String?   @db.Uuid
  type       String?
  payload    Json?
  is_read    Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

model package_items {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  package_id String?
  subject_id String?
  hours      Int?
  note       String?
  packages   packages? @relation(fields: [package_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  subjects   subjects? @relation(fields: [subject_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model packages {
  id            String          @id
  name          String
  description   String?
  price_cents   Int?
  currency      String?         @default("USD")
  billing_type  String?
  active        Boolean?        @default(true)
  created_at    DateTime?       @default(now()) @db.Timestamptz(6)
  bookings      bookings[]
  package_items package_items[]
  purchases     purchases[]

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model progress_points {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id     String?    @db.Uuid
  curriculum_id  String?
  objective_code String?
  mastery_level  String?
  last_updated   DateTime?  @default(now()) @db.Timestamptz(6)
  curricula      curricula? @relation(fields: [curriculum_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  students       students?  @relation(fields: [student_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model purchases {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id             String?   @db.Uuid
  package_id          String?
  amount_cents        Int?
  currency            String?
  status              String?
  payment_provider    String?
  payment_provider_id String?
  created_at          DateTime? @default(now()) @db.Timestamptz(6)
  packages            packages? @relation(fields: [package_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  program_id          String?   @db.Uuid
  program             Program?  @relation(fields: [program_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users               users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

model session_recordings {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id       String?   @db.Uuid
  uploaded_by      String?   @db.Uuid
  file_url         String?
  storage_path     String?
  file_size_bytes  Int?
  duration_seconds Int?
  transcript       String?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  sessions         sessions? @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users            users?    @relation(fields: [uploaded_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model sessions {
  id                 String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_id         String?              @db.Uuid
  start_time         DateTime?            @db.Timestamptz(6)
  end_time           DateTime?            @db.Timestamptz(6)
  meet_link          String?
  whiteboard_link    String?
  status             String?
  recordingRequired  Boolean?             @default(true) @map("recording_required")
  recordingUploaded  Boolean?             @default(false) @map("recording_uploaded")
  reviewedByAdmin    Boolean?             @default(false) @map("reviewed_by_admin")
  flagged            Boolean?             @default(false)
  created_at         DateTime?            @default(now()) @db.Timestamptz(6)
  attendance         Attendance[]
  program_id         String?              @db.Uuid
  program            Program?             @relation(fields: [program_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  session_recordings session_recordings[]
  session_messages   session_messages[]
  attention_status   String?
  attention_meta     Json?
  attention_events   AttentionEvent[]
  
  current_phase      SessionPhase         @default(WARM_CONNECT)
  phase_history      Json?                // [{ phase, startedAt }]
  pedagogy_status    String?

  bookings           bookings?            @relation(fields: [booking_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("app")
}

model students {
  id                                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                              String?               @db.Uuid
  first_name                           String?
  last_name                            String?
  parent_user_id                       String?               @db.Uuid
  grade                                String?
  school                               String?
  birth_date                           DateTime?             @db.Date
  curriculum_preference                String?
  interests                            Json?
  recent_focus                         String?
  struggle_areas                       Json?
  created_at                           DateTime?             @default(now()) @db.Timestamptz(6)
  assessment_attempts                  assessment_attempts[]
  attendance                           Attendance[]
  bookings                             bookings[]
  progress_points                      progress_points[]
  curricula                            curricula?            @relation(fields: [curriculum_preference], references: [id], onDelete: NoAction, onUpdate: NoAction)
  program_id                           String?               @db.Uuid
  program                              Program?              @relation(fields: [program_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_students_parent_user_idTousers users?                @relation("students_parent_user_idTousers", fields: [parent_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_students_user_idTousers        users?                @relation("students_user_idTousers", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("app")
}

model subjects {
  id                     String                   @id
  name                   String
  canonical_code         String?                  @unique
  description            String?
  created_at             DateTime?                @default(now()) @db.Timestamptz(6)
  assessments            assessments[]
  bookings               bookings[]
  curriculum_subject_map curriculum_subject_map[]
  package_items          package_items[]

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model tutor_shifts {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tutor_id    String?   @db.Uuid
  day_of_week Int?      @db.SmallInt
  start_time  DateTime? @db.Time(6)
  end_time    DateTime? @db.Time(6)
  timezone    String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  tutors      tutors?   @relation(fields: [tutor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model tutors {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id           String         @db.Uuid
  bio               String?
  qualifications    Json?
  skills            Json?
  hourly_rate_cents Int?
  employment_type   String?
  is_active         Boolean?       @default(true)
  tutor_approved    Boolean        @default(false)
  tutor_review_notes String?
  created_at        DateTime?      @default(now()) @db.Timestamptz(6)
  bookings          bookings[]
  tutor_shifts      tutor_shifts[]
  program_id        String?        @db.Uuid
  program           Program?       @relation(fields: [program_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users             users          @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("app")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model users {
  id                                      String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                                   String          @unique
  password_hash                           String?
  role                                    String
  first_name                              String?
  last_name                               String?
  phone                                   String?
  timezone                                String?         @default("UTC")
  is_active                               Boolean?        @default(true)
  email_verified                          Boolean         @default(false)
  force_password_change                   Boolean         @default(false)
  email_verification_token                String?
  email_verification_expires              DateTime?       @db.Timestamptz(6)
  tutor_invite_token                      String?
  tutor_invite_expires                    DateTime?       @db.Timestamptz(6)
  created_at                              DateTime?       @default(now()) @db.Timestamptz(6)
  assessments                             assessments[]
  audit_logs                              audit_logs[]
  notifications                           notifications[]
  purchases                               purchases[]
  students_students_parent_user_idTousers students[]      @relation("students_parent_user_idTousers")
  students_students_user_idTousers        students[]      @relation("students_user_idTousers")
  tutors                                  tutors[]
  session_messages                        session_messages[]
  session_recordings                      session_recordings[]
  blogs                                   blogs[]
  student_attention_events               AttentionEvent[] @relation("StudentAttentionEvents")
  tutor_attention_events                 AttentionEvent[] @relation("TutorAttentionEvents")
  
  // Parent-Student Relationship
  parent_id                               String?         @db.Uuid
  parent                                  users?          @relation("ParentChildren", fields: [parent_id], references: [id])
  children                                users[]         @relation("ParentChildren")
  
  // School Relationship (For School Admins)
  school_id                               String?         @db.Uuid
  school                                  School?         @relation(fields: [school_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Tutor Status
  tutor_status                            TutorStatus     @default(ACTIVE)

  @@schema("app")
}

enum TutorStatus {
  ACTIVE
  SUSPENDED

  @@schema("app")
}

model session_messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id String?   @db.Uuid
  user_id    String?   @db.Uuid
  text       String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  sessions   sessions? @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users?    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("app")
}

model blogs {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  slug        String   @unique
  excerpt     String
  content     String   @db.Text
  image_url   String
  category    String
  status      String   @default("PENDING") // PENDING, PUBLISHED, REJECTED
  author_id   String   @db.Uuid
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @updatedAt @db.Timestamptz(6)
  users       users    @relation(fields: [author_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("app")
}

model Program {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  status    String   // "draft" | "active" | "completed"

  startDate DateTime @map("start_date") @db.Timestamptz(6)
  endDate   DateTime @map("end_date") @db.Timestamptz(6)

  academic  Json
  operational Json
  financial Json
  staffing  Json
  delivery  Json
  reporting Json

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  schoolId  String?    @map("school_id") @db.Uuid
  school    School?    @relation(fields: [schoolId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  students  students[]
  tutors    tutors[]
  bookings  bookings[]
  sessions  sessions[]
  purchases purchases[]

  @@map("programs")
  @@schema("app")
}

model District {
  id   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String
  schools School[]

  @@map("districts")
  @@schema("app")
}

model School {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  districtId String?   @map("district_id") @db.Uuid
  district   District? @relation(fields: [districtId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  programs   Program[]
  users      users[]

  @@map("schools")
  @@schema("app")
}

model Attendance {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String    @map("session_id") @db.Uuid
  studentId       String    @map("student_id") @db.Uuid
  present         Boolean   @default(false)
  minutesAttended Int?      @map("minutes_attended")
  joinedAt        DateTime? @map("joined_at") @db.Timestamptz(6)
  leftAt          DateTime? @map("left_at") @db.Timestamptz(6)

  sessions        sessions  @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  students        students  @relation(fields: [studentId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("attendance")
  @@schema("app")
}

model AttentionEvent {
  id            String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId     String             @db.Uuid @map("session_id")
  studentId     String             @db.Uuid @map("student_id")
  tutorId       String             @db.Uuid @map("tutor_id")

  type          AttentionEventType
  timestamp     DateTime           @default(now()) @db.Timestamptz(6)

  metadata      Json?

  Session       sessions           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  Student       users              @relation("StudentAttentionEvents", fields: [studentId], references: [id], onDelete: Cascade)
  Tutor         users              @relation("TutorAttentionEvents", fields: [tutorId], references: [id], onDelete: Cascade)

  @@map("attention_events")
  @@schema("app")
}

enum AttentionEventType {
  CHECK_IN
  EXPLANATION
  RESPONSE
  CORRECTION
  PRAISE

  @@schema("app")
}

enum SessionPhase {
  WARM_CONNECT
  DIAGNOSE
  MICRO_TEACH
  ACTIVE_RESPONSE
  REINFORCE
  REFLECT

  @@schema("app")
}
